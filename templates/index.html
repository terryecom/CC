{% extends "base.html" %}
{% block title %}Terry Ecom Link Checker{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex main-content flex-row flex-wrap align-items-start pt-4">
        <div class="flex-grow-1 pe-3">
            <div class="bg-white rounded-4 shadow-sm px-4 py-4 mb-4">
                <h2 class="mb-3 fw-bold" style="color:#343a40;">Terry Ecom Link Checker</h2>
                <form id="crawl-form" class="row g-2 align-items-center mb-3" autocomplete="off">
                    <div class="col-md-7 col-12">
                        <input type="text" id="url" name="url" class="form-control form-control-lg" placeholder="Enter your store URL or domain" required>
                    </div>
                    <div class="col-md-3 col-6">
                        <input type="text" class="form-control form-control-lg" id="captcha" name="captcha"
                          placeholder="Captcha: {{captcha_a}}+{{captcha_b}} = ?" required>
                    </div>
                    <div class="col-md-2 col-6">
                        <button type="submit" id="start-btn" class="btn btn-primary btn-lg w-100">Start Crawl</button>
                    </div>
                </form>
                <div class="d-flex align-items-center gap-2 mb-3">
                    <button class="btn btn-outline-secondary btn-sm" id="cancel-btn" disabled>Cancel</button>
                    <button class="btn btn-outline-success btn-sm" id="export-btn" disabled>Export Results</button>
                    <span class="ms-auto small" id="pages-scanned"></span>
                </div>
                <div class="progress mb-2" style="height:24px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%; font-weight:600;">0%</div>
                </div>
                <div id="result-box" class="result-box mb-2 small" style="white-space: pre-line;"></div>
            </div>
        </div>
        <div class="sidebar ps-lg-2 w-100 w-lg-auto mt-4 mt-lg-0">
            <!-- Affiliate Card -->
            <div class="card affiliate-card border-0 shadow-sm">
                <div class="card-header bg-primary text-white rounded-top-3 fw-semibold fs-5 d-flex align-items-center" style="padding: .75rem 1.25rem;">
                    <img src="https://terryecom.com/falogo.png" alt="Freedom Achievers" style="height:34px; width:auto; margin-right:12px; border-radius:7px; background:#fff;">
                    Join Freedom Achievers Community!
                </div>
                <div class="card-body pb-3 pt-3 text-center">
                    <a href="https://www.skool.com/freedom-achievers/about?ref=7221df868ec548c58b522deaae4537fe" target="_blank" style="text-decoration:none;">
                        <img src="https://terryecom.com/fapromo.png"
                             alt="Freedom Achievers Promo" style="width:100%;max-width:370px;border-radius:18px;box-shadow:0 0 18px #eee;background:#fff;">
                    </a>
                    <div class="mt-3 mb-2 text-dark" style="font-size:16px;">
                        <b>Make $1,000/day with Google Ads Dropshipping<br>for just $199/mo</b><br>
                        <span class="text-success fw-bold">Next price increase soon‚Äîlock in your rate!</span>
                    </div>
                    <a href="https://www.skool.com/freedom-achievers/about?ref=7221df868ec548c58b522deaae4537fe"
                       target="_blank" class="btn btn-warning w-100 py-2 fw-semibold fs-6 mb-2"
                       style="border-radius: 10px; font-size: 1.1rem;">
                        üíé JOIN $199 / month
                    </a>
                    <div class="text-muted small">Secure checkout ‚Ä¢ VISA/MC/AMEX accepted</div>
                    <div class="text-secondary small mt-2">
                        ‚ÄúFrom 0 to ‚Ç¨50K in the first full month (18K+ Profit)‚Äù ‚Äî Max L.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const crawlForm = document.getElementById('crawl-form');
const resultBox = document.getElementById('result-box');
const progressBar = document.getElementById('progress-bar');
const exportBtn = document.getElementById('export-btn');
const cancelBtn = document.getElementById('cancel-btn');
const pagesScanned = document.getElementById('pages-scanned');

let polling = null, finished = false;

crawlForm.onsubmit = function(e) {
    e.preventDefault();
    resultBox.innerText = '';
    progressBar.style.width = "0%";
    progressBar.innerText = "0%";
    exportBtn.disabled = true;
    cancelBtn.disabled = false;
    pagesScanned.innerText = '';
    finished = false;
    const url = document.getElementById('url').value.trim();
    const captcha = document.getElementById('captcha').value.trim();
    fetch("/start_crawl", {
        method: "POST",
        body: new URLSearchParams({ url, captcha }),
        headers: {'Content-Type': 'application/x-www-form-urlencoded'}
    }).then(resp => resp.json()).then(data => {
        if (data.status === "started") {
            pollProgress();
        } else if (data.status === "error") {
            resultBox.innerHTML = '<span class="text-danger">'+data.msg+'</span>';
            cancelBtn.disabled = true;
        }
    }).catch(err => {
        resultBox.innerHTML = '<span class="text-danger">Error starting crawl.</span>';
        cancelBtn.disabled = true;
    });
};

function pollProgress() {
    if (polling) clearTimeout(polling);
    fetch('/progress').then(resp=>resp.json()).then(data=>{
        let logs = (data.logs || []).join('\n');
        resultBox.innerText = logs;
        let prog = data.progress || 0;
        progressBar.style.width = prog+"%";
        progressBar.innerText = prog+"%";
        pagesScanned.innerText = data.pages_scanned ? ("Pages scanned: " + data.pages_scanned) : "";
        if (!data.finished) {
            polling = setTimeout(pollProgress, 1100);
            exportBtn.disabled = true;
        } else {
            exportBtn.disabled = false;
            cancelBtn.disabled = true;
            finished = true;
        }
    });
}

cancelBtn.onclick = function() {
    fetch("/cancel", { method: "POST" });
    cancelBtn.disabled = true;
};

exportBtn.onclick = function() {
    window.location = "/export";
};
</script>
{% endblock %}
