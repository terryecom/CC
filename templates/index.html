<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Terry Ecom Link Checker</title>
    <meta name="viewport" content="width=800, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        #logArea {
            height: 320px;
            resize: none;
            font-family: monospace;
            font-size: 14px;
        }
        .contact-btns button {
            min-width: 130px;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <h2 class="mb-3">Terry Ecom Link Checker</h2>
    <div class="mb-3 row">
        <label for="urlInput" class="col-sm-2 col-form-label">Website URL:</label>
        <div class="col-sm-10">
            <input type="text" id="urlInput" class="form-control" placeholder="https://yourshopifystore.com">
        </div>
    </div>
    <div id="domainInfoBox" class="alert alert-secondary py-2 px-3" style="display:none">
        <span id="domainInfoText"></span>
    </div>
    <div class="mb-3">
        <button id="startBtn" class="btn btn-success me-2">Start Crawl</button>
        <button id="cancelBtn" class="btn btn-danger me-2">Cancel</button>
        <button id="exportBtn" class="btn btn-primary">Export Results</button>
    </div>
    <div class="mb-3">
        <textarea id="logArea" class="form-control" readonly></textarea>
    </div>
    <div class="mb-3">
        <div class="progress" style="height: 26px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
        </div>
    </div>
    <div class="mb-3">
        <span id="statusLabel">Pages Scanned: 0</span>
    </div>
    <div class="mb-3 contact-btns d-flex flex-wrap gap-2">
        <button onclick="window.open('https://www.terryecom.com','_blank')" class="btn btn-secondary">üåê Website</button>
        <button onclick="window.open('mailto:terry@terryecom.com','_blank')" class="btn btn-secondary">‚úâÔ∏è Email</button>
        <button onclick="window.open('https://www.instagram.com/terryecom/','_blank')" class="btn btn-secondary">üì∑ Instagram</button>
        <button onclick="window.open('https://x.com/TerryEcom','_blank')" class="btn btn-secondary">ùïè Twitter</button>
    </div>
</div>
<script>
    let crawlInterval = null;

    function updateLogs(logs) {
        let logArea = document.getElementById("logArea");
        logArea.value = logs.join('\n');
        logArea.scrollTop = logArea.scrollHeight;
    }

    function updateProgress(progress) {
        let bar = document.getElementById("progressBar");
        bar.style.width = progress + "%";
        bar.innerText = progress + "%";
    }

    function updateStatus(pages) {
        document.getElementById("statusLabel").innerText = "Pages Scanned: " + pages;
    }

    function pollProgress() {
        fetch('/progress').then(r=>r.json()).then(data=>{
            updateLogs(data.logs);
            updateProgress(data.progress);
            updateStatus(data.pages_scanned);
            if (data.domain_info) {
                let info = data.domain_info;
                let txt = "";
                if (info.created || info.registrar) {
                    txt = `Domain created: ${info.created || 'Unknown'}, Registrar: ${info.registrar || 'Unknown'}`;
                    document.getElementById("domainInfoText").innerText = txt;
                    document.getElementById("domainInfoBox").className = 'alert alert-secondary py-2 px-3';
                    document.getElementById("domainInfoBox").style.display = '';
                }
            }
            if(data.finished) {
                clearInterval(crawlInterval);
                crawlInterval = null;
                document.getElementById("startBtn").disabled = false;
                document.getElementById("cancelBtn").disabled = true;
            }
        });
    }

    document.getElementById("startBtn").onclick = function() {
        let url = document.getElementById("urlInput").value.trim();
        if(!url) return alert("Please enter a website URL.");
        document.getElementById("startBtn").disabled = true;
        document.getElementById("cancelBtn").disabled = false;
        document.getElementById("logArea").value = '';
        document.getElementById("domainInfoBox").style.display = 'none';
        fetch('/start_crawl', {
            method: 'POST',
            body: new URLSearchParams({url})
        })
        .then(resp => resp.json().then(data => ({status: resp.status, body: data})))
        .then(data => {
            if(data.status !== 200) {
                document.getElementById("startBtn").disabled = false;
                document.getElementById("cancelBtn").disabled = true;
                document.getElementById("domainInfoText").innerText = data.body.msg;
                document.getElementById("domainInfoBox").className = 'alert alert-danger py-2 px-3';
                document.getElementById("domainInfoBox").style.display = '';
                return;
            }
            // Show domain info
            let info = data.body.domain_info;
            let txt = `Domain created: ${info.created || 'Unknown'}, Registrar: ${info.registrar || 'Unknown'}`;
            document.getElementById("domainInfoText").innerText = txt;
            document.getElementById("domainInfoBox").className = 'alert alert-secondary py-2 px-3';
            document.getElementById("domainInfoBox").style.display = '';
            pollProgress();
            crawlInterval = setInterval(pollProgress, 1200);
        });
    };
    document.getElementById("cancelBtn").onclick = function() {
        fetch('/cancel', {method:'POST'}).then(()=>{
            document.getElementById("cancelBtn").disabled = true;
        });
    };
    document.getElementById("exportBtn").onclick = function() {
        window.open('/export','_blank');
    };
    document.getElementById("cancelBtn").disabled = true;
</script>
</body>
</html>
